<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool 01: Sliding Scale Models - Power in Numbers</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: var(--spacing-sm);
            border-bottom: var(--border-hero);
        }

        .section-header {
            background: #4E3629;
            color: #ffffff;
            padding: var(--spacing-sm);
            text-transform: uppercase;
            font-weight: 700;
        }

        .result-panel {
            background: var(--color-bg-base);
            border: var(--border-std);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .huge-number {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
        }

        .contract-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted var(--color-border);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="container">
        <header class="page-header">
            <h1>My Economies<br><span style="font-size: 0.5em; font-weight: 400;">Sliding Scale Models</span></h1>
            <div style="text-align:right;">
                <a href="independent.html" style="font-weight: 700; margin-right:15px;">&larr; BACK</a>
                <button onclick="Store.logout()"
                    style="background:none; border:none; text-decoration:underline; cursor:pointer; color:var(--color-text-muted);">Logout</button>
                <a href="profile.html" id="user-display"
                    style="display:block; font-size:0.8rem; font-weight:bold; margin-top:5px; text-decoration:none; color:inherit;">
                </a>
            </div>
        </header>

        <div class="grid-2" style="grid-template-columns: 1.5fr 1fr;">
            <!-- Left: Inputs -->
            <div style="border-right: var(--border-std);">
                <div class="section-header">
                    1. Defining the Period
                </div>
                <div style="padding: var(--spacing-sm);">
                    <div class="input-group">
                        <label>Time Period</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="in-period-value" value="1" min="1" style="width: 80px;">
                            <select id="in-period-unit"
                                style="flex-grow:1; border: none; border-bottom: 2px solid var(--color-border); font-size: 1.5rem; background: transparent;">
                                <option value="Years">Years</option>
                                <option value="Months">Months</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Confirmed Income -->
                <div class="section-header"
                    style="margin-top: var(--spacing-md); display:flex; justify-content:space-between; align-items:center;">
                    <span>Confirmed Income</span>
                    <button class="btn" onclick="openContractModal('confirmed')"
                        style="padding: 2px 8px; font-size: 0.7rem;">+ Add Source</button>
                </div>
                <div style="padding: var(--spacing-sm);">
                    <div id="confirmed-list">
                        <!-- JS Injected -->
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;">
                        <span>Total Confirmed</span>
                        <span id="out-total-confirmed-left">$0</span>
                    </div>
                </div>

                <!-- Projected Income -->
                <div class="section-header"
                    style="margin-top: var(--spacing-md); display:flex; justify-content:space-between; align-items:center;">
                    <span>Projected Income</span>
                    <button class="btn" onclick="openContractModal('projected')"
                        style="padding: 2px 8px; font-size: 0.7rem;">+ Add Source</button>
                </div>
                <div style="padding: var(--spacing-sm);">
                    <div id="projected-list">
                        <!-- JS Injected -->
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;">
                        <span>Total Projected</span>
                        <span id="out-total-projected-left">$0</span>
                    </div>
                </div>
            </div>

            <!-- Right: Results (Dual Column) -->
            <div style="padding-left: var(--spacing-md);">
                <div class="section-header">
                    3. Gap Analysis
                </div>

                <div style="margin-top: var(--spacing-md);">
                    <!-- Layout: Two Columns for Analysis -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">

                        <!-- COLUMN 1: NOW (START) -->
                        <div
                            style="background: var(--color-bg-base); border: var(--border-std); padding: var(--spacing-md);">
                            <h3
                                style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px; font-size:1rem;">
                                Recalibrated NOW Fees</h3>

                            <small>Period Target</small>
                            <div id="out-period-target-now" class="huge-number" style="font-size: 2rem;">0.00</div>
                            <div id="out-period-label-now"
                                style="margin-bottom:10px; color:var(--color-text-muted); font-size:0.8rem;">1 Years
                            </div>

                            <small>Remaining Gap</small>
                            <div id="out-gap-now"
                                style="font-size: 1.5rem; font-weight:bold; color: var(--color-text-error);">0.00</div>

                            <hr style="margin: 10px 0; border:0; border-top:1px dotted #ccc;">

                            <small>Required Rate</small>
                            <div id="out-required-rate-now" style="font-size: 1.5rem; font-weight:bold;">0.00/hr</div>
                        </div>

                        <!-- COLUMN 2: GOAL -->
                        <div
                            style="background: var(--color-bg-base); border: var(--border-std); padding: var(--spacing-md);">
                            <h3
                                style="margin-top:0; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px; font-size:1rem;">
                                Recalibrated GOAL Fees</h3>

                            <small>Period Target</small>
                            <div id="out-period-target-goal" class="huge-number" style="font-size: 2rem;">0.00</div>
                            <div id="out-period-label-goal"
                                style="margin-bottom:10px; color:var(--color-text-muted); font-size:0.8rem;">1 Years
                            </div>

                            <small>Remaining Gap</small>
                            <div id="out-gap-goal"
                                style="font-size: 1.5rem; font-weight:bold; color: var(--color-text-error);">0.00</div>

                            <hr style="margin: 10px 0; border:0; border-top:1px dotted #ccc;">

                            <small>Required Rate</small>
                            <div id="out-required-rate-goal" style="font-size: 1.5rem; font-weight:bold;">0.00/hr</div>
                        </div>
                    </div>

                    <!-- Capacity Message (Shared) -->
                    <div
                        style="text-align:center; padding:10px; margin-top:10px; font-weight:bold; background: var(--color-bg-subtle);">
                        <div id="out-capacity-msg">0 billable hours remaining</div>
                    </div>
                </div>
            </div>
            <div style="margin-top:20px; text-align:center;">
                <button class="btn" id="btn-view-spectrum" onclick="openSpectrumModal()"
                    style="width:100%; border: 1px solid var(--color-border); background: var(--color-bg-base); color: var(--color-text-main);">
                    View Rate Spectrum
                </button>
            </div>
        </div>
    </div>

    <!-- Contract Modal -->
    <dialog id="modal-contract"
        style="padding: 20px; border: 1px solid var(--color-border); background: var(--color-bg-base); color: var(--color-text-main); width: 100%; max-width: 500px; border-radius: 4px;">
        <form method="dialog">
            <h3 style="margin-top:0; border-bottom: var(--border-std); padding-bottom: 10px;">Add Income Source</h3>

            <div class="input-group">
                <label>Source / Client Name</label>
                <input type="text" id="c-name" placeholder="e.g. Client X">
            </div>

            <div class="input-group">
                <label>Calculation Method</label>
                <select id="c-method" onchange="toggleMethod()"
                    style="width:100%; padding: 0.5rem; background:transparent;">
                    <option value="rate">Rate-Based (e.g. Hours/Week)</option>
                    <option value="flat">Flat Fee / Total</option>
                </select>
            </div>

            <!-- Method A: Rate -->
            <div id="method-rate" style="border: 1px dotted var(--color-border); padding: 10px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label>Rate ($)</label>
                        <input type="number" id="c-rate" placeholder="100">
                    </div>
                    <div>
                        <label>Per</label>
                        <select id="c-rate-unit" style="width:100%; padding:0.5rem; background:transparent;">
                            <option value="Hour">Hour</option>
                            <option value="Day">Day</option>
                            <option value="Week">Week</option>
                            <option value="Month">Month</option>
                            <option value="Project">Project (Flat)</option>
                        </select>
                    </div>
                </div>

                <div
                    style="background: var(--color-bg-subtle); padding: 5px; margin-bottom: 5px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">
                    Work Density</div>
                <div style="display:flex; align-items: flex-end; gap:5px;">
                    <div style="width: 60px;">
                        <input type="number" id="c-density-value" placeholder="1">
                    </div>
                    <select id="c-density-unit" style="width: 80px; padding:0.5rem; background:transparent;">
                        <option value="Hours">Hours</option>
                        <option value="Days">Days</option>
                        <option value="Weeks">Weeks</option>
                    </select>
                    <span style="padding-bottom: 10px; font-size: 0.8rem;">PER</span>
                    <select id="c-density-freq" style="flex-grow:1; padding:0.5rem; background:transparent;">
                        <option value="Day">Day</option>
                        <option value="Week">Week</option>
                        <option value="Month">Month</option>
                        <option value="Year">Year</option>
                    </select>
                </div>

                <div style="margin-top:15px;">
                    <label>Contract Duration</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="c-duration" placeholder="1" value="1">
                        <select id="c-duration-unit" style="flex-grow:1; background:transparent;">
                            <option value="Weeks">Weeks</option>
                            <option value="Months">Months</option>
                            <option value="Years">Years</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Method B: Flat -->
            <div id="method-flat" class="hidden" style="border: 1px dotted var(--color-border); padding: 10px;">
                <div class="input-group">
                    <label>Total Contract Value ($)</label>
                    <input type="number" id="c-flat-amount" placeholder="5000">
                </div>
                <label>Period Covered</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="c-flat-duration-val" placeholder="1">
                    <select id="c-flat-duration-unit" style="flex-grow:1; background:transparent;">
                        <option value="Weeks">Weeks</option>
                        <option value="Months">Months</option>
                    </select>
                </div>
                <div id="flat-billable-calc"
                    style="margin-top:10px; font-size: 0.8rem; color: var(--color-text-muted);">
                    <!-- JS will populate estimated billable hours -->
                </div>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn" value="cancel" onclick="closeContractModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveContract()">Save Contract</button>
            </div>
        </form>
    </dialog>

    <!-- Spectrum Modal -->
    <dialog id="modal-spectrum"
        style="padding: 20px; border: 1px solid var(--color-border); background: var(--color-bg-base); color: var(--color-text-main); width: 100%; max-width: 800px; border-radius: 4px;">
        <form method="dialog">
            <h3 style="margin-top:0; border-bottom: var(--border-std); padding-bottom: 10px;">Sliding Scale Spectrum
            </h3>

            <p style="color: var(--color-text-muted);">
                Spectrum of augmented and discounted rates based on Recalibrated NOW and GOAL targets.
            </p>

            <!-- Overhead Toggles -->
            <div id="spectrum-overheads"
                style="margin-bottom: 20px; padding: 10px; background: var(--color-bg-subtle); border-radius: 4px;">
                <h5 style="margin-top:0; margin-bottom:5px;">Add Business Overhead</h5>
                <div id="overhead-toggles-list" style="display:flex; flex-wrap:wrap; gap:10px;">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- NOW Table -->
            <h4 style="margin-bottom:10px; color:var(--color-primary); border-bottom:1px solid #ddd;">Recalibrated NOW
                Spectrum</h4>
            <div style="overflow-x: auto; margin-bottom: 30px;">
                <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--color-border); text-align:center;">
                            <th style="padding:10px; background: #f6fff5;">Augmented Rate</th>
                            <th style="padding:10px; width:60px;">Aug %</th>
                            <th style="padding:10px; width:60px;">Disc %</th>
                            <th style="padding:10px; background: #fff5f5;">Discounted Rate</th>
                        </tr>
                    </thead>
                    <tbody id="spectrum-table-now"></tbody>
                </table>
            </div>

            <!-- GOAL Table -->
            <h4 style="margin-bottom:10px; color:var(--color-primary); border-bottom:1px solid #ddd;">Recalibrated GOAL
                Spectrum</h4>
            <div style="overflow-x: auto;">
                <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--color-border); text-align:center;">
                            <th style="padding:10px; background: #f6fff5;">Augmented Rate</th>
                            <th style="padding:10px; width:60px;">Aug %</th>
                            <th style="padding:10px; width:60px;">Disc %</th>
                            <th style="padding:10px; background: #fff5f5;">Discounted Rate</th>
                        </tr>
                    </thead>
                    <tbody id="spectrum-table-goal"></tbody>
                </table>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn" value="cancel" onclick="closeSpectrumModal()">Close</button>
            </div>
        </form>
    </dialog>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert('Global Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo);
            return false;
        };
    </script>
    <!-- JS IMPORTS -->
    <script src="js/utils.js?v=hotfix6"></script>
    <script src="js/supabase_client.js?v=hotfix6"></script>
    <script src="js/store.js?v=hotfix6"></script>
    <script src="js/calibrations.js"></script>

    <!-- INLINED SPECTRUM LOGIC (Nuclear Option) -->
    <script>
        // Spectrum Logic (Inlined for reliability)

        const modalSpectrum = document.getElementById('modal-spectrum');
        const tableNow = document.getElementById('spectrum-table-now');
        const tableGoal = document.getElementById('spectrum-table-goal');
        const overheadList = document.getElementById('overhead-toggles-list');

        let overheadProjects = [];
        let selectedOverheadRate = 0;
        let cachedPersonalRateNow = 0;
        let cachedPersonalRateGoal = 0;

        const DELTAS = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];

        async function openSpectrumModal() {
            // toggleOverheadSpectrum logic
            try {
                // Initialize Store if needed
                if (!window.supabaseClient) await Store.init();

                console.log("Fetching overhead projects...");
                overheadProjects = await Store.getOverheadProjects();
                console.log("Overhead projects fetched:", overheadProjects.length);

                console.log("Fetching profile...");
                const profile = await Store.getIndependentProfile();

                // User Verified: Profiles Found

                const capacity = Utils.calculateBillableCapacity(profile);
                const billableHours = capacity.totalBillableHours || 1;

                overheadProjects.forEach(p => {
                    let fixed = 0;
                    let percent = 0;
                    const expenses = p.expenses || (p.data && p.data.expenses) || [];

                    expenses.forEach(e => {
                        const val = parseFloat(e.amount) || 0;
                        if (e.type === 'Percent') percent += (e.baseAmount || val);
                        else fixed += val;
                    });

                    let cost = 0;
                    if (percent < 100) {
                        cost = fixed / (1 - (percent / 100));
                    }
                    p.hourlyRate = cost / billableHours;
                });

                renderOverheadToggles();
                renderPairedSpectrum();
                if (modalSpectrum) {
                    modalSpectrum.showModal();
                }
            } catch (err) {
                console.error("Error in openSpectrumModal:", err);
                alert("Inline System Error: " + err.message);
            }
        }

        function closeSpectrumModal() {
            if (modalSpectrum) modalSpectrum.close();
        }

        function renderOverheadToggles() {
            if (!overheadList) return;
            overheadList.innerHTML = '';
            if (overheadProjects.length === 0) {
                overheadList.innerHTML = '<span style="color:#888; font-size:0.8rem;">No business profiles found (Database Empty).</span>';
                return;
            }
            overheadProjects.forEach(p => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.padding = '5px';
                label.style.border = '1px solid #eee';
                label.style.borderRadius = '4px';
                label.style.fontSize = '0.8rem';
                label.style.background = '#fff';
                label.style.cursor = 'pointer';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = p.id;
                checkbox.style.marginRight = '8px';
                checkbox.onchange = recalculateSelectedOverhead;

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(`${p.name} (+$${p.hourlyRate.toFixed(2)}/hr)`));
                overheadList.appendChild(label);
            });
        }

        function recalculateSelectedOverhead() {
            selectedOverheadRate = 0;
            const checkboxes = overheadList.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(cb => {
                const proj = overheadProjects.find(p => p.id == cb.value);
                if (proj) selectedOverheadRate += proj.hourlyRate;
            });
            renderPairedSpectrum();
        }

        function renderPairedSpectrum() {
            // Re-read inputs or use cached profile data? 
            // Better to pull from DOM elements if possible to match live edits, 
            // but for now let's assume saved data since modal triggers a "save state" usually.
            // Actually, we need to read the "out-now-hourly" and "out-goal-hourly" from the page if avail,
            // OR re-calculate. The independent page calculates them and puts them in Store.profile?
            // Let's grab from the DOM outputs since they are right there.

            const elNow = document.getElementById('out-required-rate-now');
            const elGoal = document.getElementById('out-required-rate-goal');

            const nowRateText = elNow ? elNow.textContent.replace(/[^0-9.]/g, '') : '0';
            const goalRateText = elGoal ? elGoal.textContent.replace(/[^0-9.]/g, '') : '0';

            cachedPersonalRateNow = parseFloat(nowRateText) || 0;
            cachedPersonalRateGoal = parseFloat(goalRateText) || 0;

            const rateNowWithOverhead = cachedPersonalRateNow + selectedOverheadRate;
            const rateGoalWithOverhead = cachedPersonalRateGoal + selectedOverheadRate;

            renderTable(tableNow, rateNowWithOverhead);
            renderTable(tableGoal, rateGoalWithOverhead);
        }

        function renderTable(tbody, baseRate) {
            tbody.innerHTML = '';
            if (baseRate <= 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">Calculate a base rate first.</td></tr>';
                return;
            }

            DELTAS.forEach(delta => {
                const multAug = 1 + delta;
                const multDisc = 1 - delta;

                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';

                // 1. Augmented Rate Cell
                const tdAugRate = createRateCell(baseRate, multAug);
                tdAugRate.style.background = '#f6fff5';

                // 2. Aug %
                const tdAugPct = document.createElement('td');
                tdAugPct.textContent = `+${Math.round(delta * 100)}%`;
                tdAugPct.style.textAlign = 'center';
                tdAugPct.style.fontWeight = 'bold';
                tdAugPct.style.background = '#e6fffa';

                // 3. Disc %
                const tdDiscPct = document.createElement('td');
                tdDiscPct.textContent = `-${Math.round(delta * 100)}%`;
                tdDiscPct.style.textAlign = 'center';
                tdDiscPct.style.fontWeight = 'bold';
                tdDiscPct.style.background = '#fff5f5';

                // 4. Discounted Rate Cell
                const tdDiscRate = createRateCell(baseRate, multDisc);
                tdDiscRate.style.background = '#fff0eb';

                tr.appendChild(tdAugRate);
                tr.appendChild(tdAugPct);
                tr.appendChild(tdDiscPct);
                tr.appendChild(tdDiscRate);

                tbody.appendChild(tr);
            });
        }

        // Helper for formatting rate cells (matches reference)
        function createRateCell(baseRate, multiplier) {
            const td = document.createElement('td');
            td.style.padding = '10px';
            td.style.textAlign = 'center';

            // Assume 6 hours/day, 4 days/week if not in store (Hardcoded fallback if store logic missing from inline)
            // But we can try to fetch from store if available, or just standard.
            // Reference used: hoursPerDay, daysPerWeek from profile.
            // We'll calculate simple standard for display.
            const hpd = 6;
            const dpw = 4; // Standard independent work week

            const hourly = baseRate * multiplier;
            const daily = hourly * hpd;
            const weekly = daily * dpw;

            // Format: $100/hr <br> <small>$600/day | $2400/wk</small>
            td.innerHTML = `
                <div style="font-weight:bold; font-size:1rem;">${Utils.formatCurrency(hourly)}/hr</div>
                <div style="font-size:0.75rem; color:#666; margin-top:2px;">
                    ${Utils.formatCurrency(daily)}/day â€¢ ${Utils.formatCurrency(weekly)}
                </div>
            `;
            return td;
        }

        // Init Logic (Page Load)
        (async () => {
            await Store.init();
            const currentUser = await Store.checkSession();
            if (currentUser) {
                document.getElementById('user-display').textContent = 'User: ' + currentUser;
            }
        })();
    </script>

    <div
        style="text-align: center; color: green; font-weight: bold; padding: 10px; border-top: 1px solid #ccc; margin-top: 20px;">
        System Ready v6 (Inlined)
    </div>
    <script src="js/calibrations.js"></script>
</body>

</html>