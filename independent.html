<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Independent Tool - Power in Numbers</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Extra grid specifics for this page */
        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: var(--spacing-sm);
            border-bottom: var(--border-hero);
        }

        .side-nav {
            border-bottom: var(--border-std);
            padding: var(--spacing-sm);
        }

        .section-header {
            background: #4E3629;
            color: #ffffff;
            padding: var(--spacing-sm);
            text-transform: uppercase;
            font-weight: 700;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="main-container" class="grid-container">
        <!-- DEBUG CONSOLE (Temporary) -->
        <div id="debug-console"
            style="background: #ffebee; border: 2px solid #ef5350; color: #c62828; padding: 10px; margin: 10px; font-family: monospace; white-space: pre-wrap; display: block;">
            Debug Log Initializing...</div>
        <script>
            window.onerror = function (msg, url, line, col, error) {
                const el = document.getElementById('debug-console');
                if (el) el.innerHTML += `\nGLOBAL ERROR: ${msg}\nLine: ${line}`;
                return false;
            };
            window.addEventListener('unhandledrejection', function (event) {
                const el = document.getElementById('debug-console');
                if (el) el.innerHTML += `\nUNHANDLED PROMISE: ${event.reason}`;
            });
        </script>

        <div class="grid-header">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:baseline;">
                <h1>My Economic<br>Dream Plans</h1>
                <div style="text-align:right;">
                    <a href="index.html" style="font-weight: 700; margin-right:15px;">&larr; INDEX</a>
                    <button onclick="Store.logout()"
                        style="background:none; border:none; text-decoration:underline; cursor:pointer; color:var(--color-text-muted);">Logout</button>
                    <a href="profile.html" id="user-display"
                        style="display:block; font-size:0.8rem; font-weight:bold; margin-top:5px; text-decoration:none; color:inherit;">
                    </a>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <p>This is your logic map. Define how your needs translate into your rates.</p>
        </div>
        <script>
            // Inline session check to prevent flash of content
            // However, Store.js needs to be loaded first.
            // We will rely on the script tag at bottom check, or move script up.
            // For now, let's just add the UI elements and rely on the bottom script check.
        </script>

        <div class="grid-2">
            <!-- Left Column: The Ledger Inputs -->
            <div style="border-right: var(--border-std);">

                <div class="section-header">1. Time Reclaimed Schedule</div>

                <div class="ledger-row">
                    <label>Weeks / Year</label>
                    <div style="width: 80px;">
                        <input type="number" id="in-weeks" min="1" max="52" placeholder="40">
                    </div>
                </div>

                <div class="ledger-row">
                    <label>Days / Week</label>
                    <div style="width: 80px;">
                        <input type="number" id="in-days" min="1" max="7" placeholder="4">
                    </div>
                </div>

                <div class="ledger-row">
                    <label>Hours / Day</label>
                    <div style="width: 80px;">
                        <input type="number" id="in-hours" min="1" max="24" placeholder="6">
                    </div>
                </div>

                <!-- Lines of Work Calculator -->
                <div
                    style="margin-top: var(--spacing-sm); border-top: 1px dotted var(--color-border); padding-top: var(--spacing-sm);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <button class="toggle-btn" onclick="toggleSection('lines-of-work-container', this)">
                            <span class="toggle-icon">▼</span>
                            <label
                                style="margin:0; font-size: 0.7rem; text-transform:uppercase; letter-spacing:1px; cursor:pointer;">Lines
                                of Work</label>
                        </button>
                        <button id="btn-add-line-of-work"
                            style="font-size: 0.7rem; padding: 2px 6px; cursor: pointer;">+ New Line</button>
                    </div>
                    <div id="lines-of-work-container">
                        <!-- JS injected Lines of Work cards -->
                    </div>
                </div>

                <!-- Hours Summary -->
                <div
                    style="margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: var(--border-std);">
                    <div class="ledger-row" style="border-bottom:none; padding: 0.25rem 0;">
                        <span class="text-muted" style="font-size: 0.8rem; text-transform: uppercase;">Total Annual Work
                            Hours</span>
                        <span id="out-total-work-hours" class="data-value">0</span>
                    </div>
                    <div class="ledger-row" style="border-bottom:none; padding: 0.25rem 0;">
                        <span class="text-muted" style="font-size: 0.8rem; text-transform: uppercase;">Total Annual
                            Non-Billable Hours</span>
                        <span id="out-total-non-billable-hours" class="data-value">0</span>
                    </div>
                    <div class="ledger-row" style="border-bottom:none; padding: 0.25rem 0;">
                        <span class="text-muted"
                            style="font-size: 0.8rem; text-transform: uppercase; font-weight: bold;">Total Annual
                            Billable Hours</span>
                        <span id="out-total-billable-hours" class="data-value" style="font-weight: bold;">0</span>
                    </div>
                </div>

                <!-- Tax Rate Input (Retained) -->

                <div style="padding: var(--spacing-sm); border-bottom: var(--border-std);">
                    <div class="ledger-row" style="flex-wrap: wrap;">
                        <label>Estimated Tax Rate (%)</label>
                        <div style="width: 80px;">
                            <input type="number" id="in-tax-rate" min="0" max="100" placeholder="30">
                        </div>
                        <div
                            style="width: 100%; font-size: 0.7rem; color: var(--color-text-muted); margin-top: 5px; font-style: italic;">
                            We suggest keeping this at 30% for self-employed folks
                        </div>
                    </div>
                </div>


            </div>

            <!-- Section 2: Personal Expenses -->
            <div class="section-header"
                style="margin-top: var(--spacing-md); display:flex; justify-content:space-between; align-items:center;">
                <button class="toggle-btn" onclick="toggleSection('expenses-container', this)">
                    <span class="toggle-icon">▼</span>
                    <span style="font-size: 0.9rem; font-weight:700;">2. Personal Survival Expenses</span>
                </button>
                <button id="btn-add-expense" style="font-size: 0.7rem; padding: 2px 6px; cursor: pointer;">+ Add
                    Expense</button>
            </div>
            <div id="expenses-container" style="padding: var(--spacing-sm);">
                <!-- JS injected Expense Rows -->
            </div>

            <!-- Business Overhead Profiles -->
            <div class="section-header"
                style="margin-top: var(--spacing-md); display:flex; justify-content:space-between; align-items:center;">
                <button class="toggle-btn" onclick="toggleSection('overhead-profiles-container', this)">
                    <span class="toggle-icon">▼</span>
                    <span style="font-size: 0.9rem; font-weight:700;">Business Infrastructures</span>
                </button>
                <button class="btn" id="btn-add-overhead-profile" style="padding: 2px 8px; font-size: 0.7rem;">+ Create
                    Profile</button>
            </div>
            <div id="overhead-profiles-container" style="padding: var(--spacing-sm);">
                <!-- JS Injected Overhead Profiles -->
                <div style="font-style:italic; color:#666; font-size:0.9rem;">No business profiles yet. Create one to
                    account for overhead.</div>
            </div>



            <!-- Section 3: Unearned Income -->
            <div class="section-header"
                style="margin-top: var(--spacing-md); display:flex; justify-content:space-between; align-items:center;">
                <button class="toggle-btn" onclick="toggleSection('unearned-income-container', this)">
                    <span class="toggle-icon">▼</span>
                    <span style="font-size: 0.9rem; font-weight:700;">3. Current Unearned Income Sources</span>
                </button>
                <button id="btn-add-income" style="font-size: 0.7rem; padding: 2px 6px; cursor: pointer;">+ Add
                    Income Source</button>
            </div>

            <div id="unearned-income-container" style="padding: var(--spacing-sm);">
                <!-- JS Injected Income Rows -->
            </div>
            <!-- Total Unearned Footer -->
            <div
                style="padding: var(--spacing-sm); background: var(--color-bg-subtle); border-top: var(--border-std); display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size:0.8rem; text-transform:uppercase;">Total Annual Unearned
                    Income</span>
                <span id="out-total-unearned-income" style="font-weight:bold; font-family:monospace;">$0</span>
            </div>

            <!-- Section 4: Current Annual Income (Net) -->
            <div class="section-header"
                style="margin-top: var(--spacing-md); display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size: 0.9rem;">4. Current Annual Income (Net)</span>
            </div>

            <div style="padding: var(--spacing-sm); border-bottom: var(--border-std);">
                <div class="ledger-row">
                    <label>Current Net Income</label>
                    <div style="width: 120px;">
                        <input type="number" id="in-current-net-income" placeholder="0">
                    </div>
                </div>
                <div class="ledger-row" style="margin-top:5px; border-bottom:none;">
                    <span class="text-muted" style="font-size:0.8rem; font-weight:bold;">Current Gross Income</span>
                    <span>
                        <strong id="out-current-gross">$0</strong>
                        <button onclick="window.viewIndependentLog('currentGross')"
                            style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                    </span>
                </div>
            </div>
        </div>

        <!-- Right Column: Results Dock -->
        <div>
            <aside class="result-dock">
                <div style="margin-bottom: var(--spacing-lg); margin-top: var(--spacing-lg);">
                    <div class="result-label">Goal Annual Income<br><span style="font-weight:400; font-size:0.8em;">(Net
                            / After Tax)</span>
                        <button onclick="window.viewIndependentLog('goalNet')"
                            style="background:none; border:none; cursor:pointer; opacity:0.6;">ℹ️</button>
                    </div>
                    <div class="result-value" id="out-goal-net">$0</div>
                </div>

                <div style="margin-bottom: var(--spacing-lg);">
                    <div class="result-label">Goal Annual Income<br><span
                            style="font-weight:400; font-size:0.8em;">(Gross / Accounting for Taxes)</span>
                        <button onclick="window.viewIndependentLog('goalGross')"
                            style="background:none; border:none; cursor:pointer; opacity:0.6;">ℹ️</button>
                    </div>
                    <div class="result-value" id="out-goal-gross" style="color: var(--color-accent-primary);">$0
                    </div>
                </div>

                <!-- Hours Dock -->
                <div
                    style="margin-bottom: var(--spacing-lg); padding-top: var(--spacing-sm); border-top: 1px dotted var(--color-border);">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom: 5px;">
                        <span class="text-muted">Total Non-Billable</span>
                        <span id="out-dock-total-non-billable" style="font-weight:bold;">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                        <span class="text-muted" style="font-weight:bold;">Total Billable</span>
                        <span id="out-dock-total-billable"
                            style="font-weight:bold; color: var(--color-accent-primary);">0</span>
                    </div>
                </div>

                <!-- FEES Separation -->
                <div
                    style="margin-top: var(--spacing-lg); padding-top: var(--spacing-sm); border-top: 2px solid var(--color-border);">

                    <!-- NOW FEES -->
                    <div style="margin-bottom: var(--spacing-md);">
                        <div class="result-label"
                            style="text-align:center; color: var(--color-text-muted); margin-bottom: 5px;">NOW Fees
                        </div>
                        <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Hourly</td>
                                <td style="text-align:right;">
                                    <strong id="out-now-hourly">$0</strong>
                                    <button onclick="window.viewIndependentLog('nowHourly')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Daily</td>
                                <td style="text-align:right;">
                                    <strong id="out-now-daily">$0</strong>
                                    <button onclick="window.viewIndependentLog('nowDaily')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Weekly</td>
                                <td style="text-align:right;">
                                    <strong id="out-now-weekly">$0</strong>
                                    <button onclick="window.viewIndependentLog('nowWeekly')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Monthly</td>
                                <td style="text-align:right;">
                                    <strong id="out-now-monthly">$0</strong>
                                    <button onclick="window.viewIndependentLog('nowMonthly')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- GOAL FEES -->
                    <div>
                        <div class="result-label"
                            style="text-align:center; color: var(--color-accent-primary); margin-bottom: 5px;">GOAL
                            Fees</div>
                        <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Hourly</td>
                                <td style="text-align:right; color: var(--color-accent-primary);">
                                    <strong id="out-goal-hourly">$0</strong>
                                    <button onclick="window.viewIndependentLog('goalHourly')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Daily</td>
                                <td style="text-align:right; color: var(--color-accent-primary);">
                                    <strong id="out-goal-daily">$0</strong>
                                    <button onclick="window.viewIndependentLog('goalDaily')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Weekly</td>
                                <td style="text-align:right; color: var(--color-accent-primary);">
                                    <strong id="out-goal-weekly">$0</strong>
                                    <button onclick="window.viewIndependentLog('goalWeekly')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: var(--color-text-muted);">Monthly</td>
                                <td style="text-align:right; color: var(--color-accent-primary);">
                                    <strong id="out-goal-monthly">$0</strong>
                                    <button onclick="window.viewIndependentLog('goalMonthly')"
                                        style="background:none; border:none; cursor:pointer; opacity:0.6; font-size:0.8rem;">ℹ️</button>
                                </td>
                            </tr>
                        </table>
                    </div>

            </aside>
        </div>

        <!-- Sub-Dashboards Navigation -->
        <div style="grid-column: 2; margin-top: var(--spacing-sm);">
            <h4
                style="margin-bottom: var(--spacing-sm); font-size: 0.8rem; text-transform: uppercase; color: var(--color-text-muted);">
                Deep Dives</h4>
            <a href="independent_sliding_scales.html" class="btn"
                style="display:flex; width:100%; margin-bottom:10px; font-size: 0.8rem; justify-content: space-between; text-decoration:none;">
                Some NOW Calibrations <span>&rarr;</span>
            </a>
            <a href="independent_meantime.html" class="btn"
                style="display:flex; width:100%; margin-bottom:10px; font-size: 0.8rem; justify-content: space-between; text-decoration:none;">
                Meantime Steps <span>&rarr;</span>
            </a>
            <a href="independent_calibrations.html" class="btn"
                style="display:flex; width:100%; font-size: 0.8rem; justify-content: space-between; text-decoration:none;">
                Period Planning <span>&rarr;</span>
            </a>
        </div>
    </div>
    </div>

    <!-- Validation Modal -->
    <dialog id="modal-override"
        style="padding: 20px; border: 1px solid var(--color-border); background: var(--color-bg-base); color: var(--color-text-main); max-width: 400px; border-radius: 4px;">
        <form method="dialog">
            <h3 style="margin-top:0; color: var(--color-accent-surviving);">Confirm Duration</h3>
            <p id="modal-override-msg" style="margin: 15px 0; line-height: 1.5;"></p>
            <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" onclick="cancelOverride()"
                    style="padding: 8px 16px; cursor:pointer; background:none; border:1px solid var(--color-border); color:var(--color-text-main);">Cancel</button>
                <button type="button" onclick="confirmOverride()"
                    style="padding: 8px 16px; background: var(--color-accent-surviving); color: #000; border: none; cursor:pointer; font-weight:bold;">Override</button>
            </div>
        </form>
    </dialog>

    <!-- Modal: Math Log -->
    <div id="modal-math-log"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:var(--color-bg-base); padding:20px; border-radius:8px; max-width:600px; width:90%; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
            <div
                style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Calculation Details</h3>
                <button onclick="document.getElementById('modal-math-log').style.display='none'"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="math-log-content"
                style="max-height:400px; overflow-y:auto; font-family:var(--font-mono); font-size:0.9rem; line-height:1.6;">
                <!-- JS Injected Content -->
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button onclick="document.getElementById('modal-math-log').style.display='none'"
                    class="btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/supabase_client.js"></script>
    <script src="js/store.js"></script>
    <script>
        /**
         * Independent Tool Logic - Final Refactor (Inlined for Debugging)
         */

        // Global Toggle Function
        window.toggleSection = (id, btn) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('hidden');
                btn.classList.toggle('collapsed');
            }
        };

        // Debug Logger
        function logToScreen(msg) {
            console.log(msg);
            const el = document.getElementById('debug-console');
            if (el) {
                const time = new Date().toLocaleTimeString();
                el.innerHTML += `\n[${time}] ${msg}`;
            }
        }

        const outputs = {
            goalNet: document.getElementById('out-goal-net'),
            goalGross: document.getElementById('out-goal-gross'),
            dayRate: document.getElementById('out-day-rate'),

            totalWorkHours: document.getElementById('out-total-work-hours'),
            totalNonBillable: document.getElementById('out-total-non-billable-hours'),
            totalBillable: document.getElementById('out-total-billable-hours')
        };

        // 2. State Management
        let profile = {};
        let overheadProjects = [];

        // const BASE_EXPENSE_CATEGORIES = [ ... ]; // Already defined in store.js
        // using global BASE_EXPENSE_CATEGORIES from store.js        ];

        const Normalizer = Utils.Normalizer;

        // EXPENSE MANAGER
        const ExpenseManager = {
            container: document.getElementById('expenses-container'),

            render: () => {
                ExpenseManager.container.innerHTML = '';
                profile.expenses.items.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'ledger-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '2fr 1fr 1fr 1fr auto';
                    row.style.gap = '10px';
                    row.style.alignItems = 'center';

                    const showFreq = item.type === 'Periodic';

                    row.innerHTML = `
                    <input type="text" value="${item.label}" placeholder="Category" onchange="updateExpense(${index}, 'label', this.value)">
                    <input type="number" value="${item.amount}" placeholder="Amount" onchange="updateExpense(${index}, 'amount', this.value)">
                    <select onchange="updateExpense(${index}, 'type', this.value)">
                        <option value="Monthly" ${item.type === 'Monthly' ? 'selected' : ''}>Monthly</option>
                        <option value="Periodic" ${item.type === 'Periodic' ? 'selected' : ''}>Periodic (x/Yr)</option>
                        <option value="Percent" ${item.type === 'Percent' ? 'selected' : ''}>% of Total</option>
                    </select>
                     <input type="number" value="${item.frequency || 1}" placeholder="Freq" 
                        style="visibility: ${showFreq ? 'visible' : 'hidden'}; width: 60px;"
                        onchange="updateExpense(${index}, 'frequency', this.value)">
                    <button onclick="removeExpense(${index})" style="color:red; background:none; border:none; cursor:pointer;">&times;</button>
                `;
                    ExpenseManager.container.appendChild(row);
                });
            },

            addExpense: () => {
                profile.expenses.items.push({
                    id: crypto.randomUUID(),
                    label: '',
                    amount: 0,
                    type: 'Monthly',
                    frequency: 1
                });
                ExpenseManager.render();
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            },

            removeExpense: (index) => {
                if (confirm('Remove this expense?')) {
                    profile.expenses.items.splice(index, 1);
                    ExpenseManager.render();
                    calculateAndDisplay();
                    Store.saveIndependentProfile(profile);
                }
            },

            updateExpense: (index, field, value) => {
                const val = (field === 'amount' || field === 'frequency') ? parseFloat(value) : value;
                profile.expenses.items[index][field] = val;
                if (field === 'type') ExpenseManager.render();

                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            }
        };

        // INCOME MANAGER
        const IncomeManager = {
            container: document.getElementById('unearned-income-container'),

            render: () => {
                IncomeManager.container.innerHTML = '';
                profile.unearnedIncome.items.forEach((item, index) => {
                    const row = document.createElement('div');
                    row.className = 'ledger-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '2fr 1fr 1fr 1fr auto';
                    row.style.gap = '10px';
                    row.style.alignItems = 'center';

                    const showFreq = item.type === 'Periodic';

                    row.innerHTML = `
                    <input type="text" value="${item.label}" placeholder="Source" onchange="updateIncome(${index}, 'label', this.value)">
                    <input type="number" value="${item.amount}" placeholder="Amount" onchange="updateIncome(${index}, 'amount', this.value)">
                    <select onchange="updateIncome(${index}, 'type', this.value)">
                        <option value="Annual" ${item.type === 'Annual' ? 'selected' : ''}>Annual</option>
                        <option value="Monthly" ${item.type === 'Monthly' ? 'selected' : ''}>Monthly</option>
                        <option value="Periodic" ${item.type === 'Periodic' ? 'selected' : ''}>Periodic (x/Yr)</option>
                    </select>
                     <input type="number" value="${item.frequency || 1}" placeholder="Freq" 
                        style="visibility: ${showFreq ? 'visible' : 'hidden'}; width: 60px;"
                        onchange="updateIncome(${index}, 'frequency', this.value)">
                    <button onclick="removeIncome(${index})" style="color:red; background:none; border:none; cursor:pointer;">&times;</button>
                `;
                    IncomeManager.container.appendChild(row);
                });
            },

            addIncome: () => {
                profile.unearnedIncome.items.push({
                    id: crypto.randomUUID(),
                    label: '',
                    amount: 0,
                    type: 'Annual',
                    frequency: 1
                });
                IncomeManager.render();
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            },

            removeIncome: (index) => {
                if (confirm('Remove this income source?')) {
                    profile.unearnedIncome.items.splice(index, 1);
                    IncomeManager.render();
                    calculateAndDisplay();
                    Store.saveIndependentProfile(profile);
                }
            },

            updateIncome: (index, field, value) => {
                const val = (field === 'amount' || field === 'frequency') ? parseFloat(value) : value;
                profile.unearnedIncome.items[index][field] = val;
                if (field === 'type') IncomeManager.render();

                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            }
        };

        // BUSINESS PROFILE MANAGER
        const BusinessProfileManager = {
            container: document.getElementById('overhead-profiles-container'),

            render: () => {
                if (!BusinessProfileManager.container) return;
                BusinessProfileManager.container.innerHTML = '';

                if (overheadProjects.length === 0) {
                    BusinessProfileManager.container.innerHTML = '<div style="font-style:italic; color:#666; font-size:0.9rem;">No business profiles yet. Create one to account for overhead.</div>';
                    return;
                }

                overheadProjects.forEach((proj, index) => {
                    const row = document.createElement('div');
                    row.className = 'ledger-row';
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.alignItems = 'center';
                    row.style.marginBottom = '10px';
                    row.style.background = '#fff';
                    row.style.padding = '8px';
                    row.style.border = '1px solid #eee';

                    const totalExp = (proj.expenses || []).reduce((acc, item) => acc + (parseFloat(item.amount || 0)), 0);

                    row.innerHTML = `
                    <div style="flex-grow:1;">
                        <input type="text" value="${proj.name}" 
                            onchange="BusinessProfileManager.update(${index}, 'name', this.value)"
                            style="font-weight:bold; width:100%; border:none; background:transparent;">
                        <div style="font-size:0.8rem; color:#666;">
                            Total Overhead: <strong>$${totalExp.toLocaleString()}</strong> 
                            <button onclick="BusinessProfileManager.editExpenses('${proj.id}')" style="text-decoration:underline; border:none; background:none; cursor:pointer; color:var(--color-primary);">Edit Expenses</button>
                        </div>
                    </div>
                    <button onclick="BusinessProfileManager.remove(${index})" style="color:red; background:none; border:none; cursor:pointer;">&times;</button>
                `;
                    BusinessProfileManager.container.appendChild(row);
                });
            },

            create: async () => {
                const name = prompt("Enter Business Name (e.g. Makini Makes):");
                if (!name) return;
                try {
                    const newProj = await Store.createOverheadProject(name);
                    if (newProj) {
                        overheadProjects.push(newProj);
                        BusinessProfileManager.render();
                        renderLinesOfWork();
                    }
                } catch (e) { alert(e.message); }
            },

            update: async (index, field, value) => {
                overheadProjects[index][field] = value;
                try {
                    await Store.saveOverheadProject(overheadProjects[index]);
                } catch (e) { console.error(e); }
            },

            remove: async (index) => {
                if (!confirm("Delete this business profile?")) return;
                alert("Deletion not fully supported in this draft. (Contact support to remove DB row)");
            },

            editExpenses: (id) => {
                const proj = overheadProjects.find(p => p.id === id);
                if (!proj) return;

                let currentAmount = 0;
                if (proj.expenses && proj.expenses.length > 0) {
                    currentAmount = proj.expenses[0].amount;
                }

                const newAmount = prompt(`Enter Total Annual Overhead for ${proj.name}:`, currentAmount);
                if (newAmount !== null) {
                    const val = parseFloat(newAmount) || 0;
                    proj.expenses = [{ label: "Annual Overhead", amount: val, type: "Annual" }];
                    Store.saveOverheadProject(proj);
                    BusinessProfileManager.render();
                    calculateAndDisplay();
                }
            }
        };
        window.BusinessProfileManager = BusinessProfileManager;

        // LINE ITEMS (Work)
        const LineManager = {
            container: document.getElementById('lines-of-work-container'),

            render: () => {
                LineManager.container.innerHTML = '';
                const globalWeeks = parseFloat(inputs.weeks.value) || 0;
                const globalDays = parseFloat(inputs.days.value) || 0;
                const globalHours = parseFloat(inputs.hours.value) || 0;

                profile.linesOfWork.forEach((line, lineIndex) => {
                    const card = document.createElement('div');
                    card.className = 'grid-card';
                    card.style.marginBottom = 'var(--spacing-md)';
                    card.style.padding = 'var(--spacing-sm)';
                    card.style.border = '1px solid var(--color-border)';

                    const header = document.createElement('div');
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';
                    header.style.marginBottom = 'var(--spacing-sm)';
                    header.style.borderBottom = '1px dotted var(--color-border)';
                    header.style.paddingBottom = 'var(--spacing-xs)';

                    const overheadOptions = overheadProjects.map(proj =>
                        `<option value="${proj.id}" ${line.overheadProjectId === proj.id ? 'selected' : ''}>${proj.name}</option>`
                    ).join('');

                    header.innerHTML = `
                    <div style="display:flex; gap: var(--spacing-sm); width: 100%;">
                        <div style="flex-grow:1;">
                            <label style="font-size:0.6rem;">Role / Line of Work</label>
                            <input type="text" value="${line.label}" onchange="updateLine(${lineIndex}, 'label', this.value)" style="width:100%;">
                        </div>
                        <div style="width: 80px;">
                            <label style="font-size:0.6rem;">Duration</label>
                            <input type="number" value="${line.duration.value}" onchange="updateLineDuration(${lineIndex}, 'value', this.value)" placeholder="0">
                        </div>
                        <div style="width: 90px;">
                             <label style="font-size:0.6rem;">Unit</label>
                             <select onchange="updateLineDuration(${lineIndex}, 'unit', this.value)">
                                <option value="Weeks" ${line.duration.unit === 'Weeks' ? 'selected' : ''}>Weeks</option>
                                <option value="Months" ${line.duration.unit === 'Months' ? 'selected' : ''}>Months</option>
                                <option value="% of Year" ${line.duration.unit === '% of Year' ? 'selected' : ''}>% of Year</option>
                             </select>
                        </div>
                    </div>
                    <button onclick="removeLine(${lineIndex})" style="color:red; background:none; border:none; cursor:pointer; font-size:1.2rem; line-height:1;">&times;</button>
                `;
                    card.appendChild(header);

                    const overheadSelectorDiv = document.createElement('div');
                    overheadSelectorDiv.style.marginBottom = 'var(--spacing-sm)';

                    let rateDisplay = '';
                    let computedOverheadRate = 0;

                    if (line.overheadProjectId) {
                        const linkedProj = overheadProjects.find(p => p.id === line.overheadProjectId);
                        if (linkedProj) {
                            const totalOverhead = (linkedProj.expenses || []).reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
                            let lineWeeks = parseFloat(line.duration.value) || 0;
                            if (line.duration.unit === 'Months') lineWeeks *= 4.33;
                            if (line.duration.unit === 'Years') lineWeeks *= 52;

                            const weeklyHours = (line.activities || []).reduce((sum, act) => sum + (parseFloat(act.amount) || 0), 0);
                            const totalLineHours = lineWeeks * weeklyHours;

                            if (window.BudgetEngine) {
                                computedOverheadRate = BudgetEngine.calculateOverheadRate(totalOverhead, totalLineHours);
                            } else {
                                // Fallback relative calculation if engine missing
                                computedOverheadRate = totalLineHours > 0 ? (totalOverhead / totalLineHours) : 0;
                            }

                            line.derivedOverheadRate = computedOverheadRate;

                            if (totalLineHours > 0) {
                                rateDisplay = `<div style="margin-top:5px; font-size:0.8rem; color:var(--color-primary); font-weight:bold; background:var(--color-bg-subtle); padding:5px; border-radius:4px;">
                                Linked Overhead Rate: $${computedOverheadRate.toFixed(2)}/hr
                                <span style="font-weight:normal; color:#666;">(${linkedProj.name}: $${totalOverhead.toLocaleString()} / ${Math.round(totalLineHours)} hrs)</span>
                            </div>`;
                            } else {
                                rateDisplay = `<div style="margin-top:5px; font-size:0.8rem; color:red;">Add activities to calculate rate.</div>`;
                            }
                        }
                    } else {
                        line.derivedOverheadRate = 0;
                    }

                    overheadSelectorDiv.innerHTML = `
                    <label style="font-size:0.6rem;">Associated Business Profile (Overhead)</label>
                    <select onchange="updateLine(${lineIndex}, 'overheadProjectId', this.value)" style="width:100%; margin-bottom:5px;">
                        <option value="">None</option>
                        ${overheadOptions}
                    </select>
                    ${rateDisplay}
                `;
                    card.appendChild(overheadSelectorDiv);

                    const actsContainer = document.createElement('div');
                    const subHeader = document.createElement('div');
                    subHeader.style.display = 'flex';
                    subHeader.style.justifyContent = 'space-between';
                    subHeader.style.marginBottom = 'var(--spacing-xs)';
                    subHeader.innerHTML = `
                     <div style="font-size:0.7rem; font-weight:bold;">NON-BILLABLE ACTIVITIES</div>
                     <button onclick="addActivity(${lineIndex})" style="font-size:0.7rem; cursor:pointer;">+ Service</button>
                `;
                    card.appendChild(subHeader);

                    line.activities.forEach((act, actIndex) => {
                        const lineWeeks = Normalizer.getLineWeeks(line.duration.value, line.duration.unit, globalWeeks);
                        const annualHours = Normalizer.getActivityAnnualHours(act, lineWeeks, globalDays, globalHours);
                        const isInvalid = annualHours === -1;

                        const displayValue = isInvalid ?
                            `<span style="color:var(--color-accent-surviving); font-weight:bold; font-size:0.6rem;">please revise your selections</span>` :
                            `≈ ${Math.round(annualHours)} hrs`;

                        const actRow = document.createElement('div');
                        actRow.style.display = 'grid';
                        actRow.style.gridTemplateColumns = '2fr 1fr 1fr 1fr auto auto';
                        actRow.style.gap = '5px';
                        actRow.style.marginBottom = '5px';
                        actRow.style.alignItems = 'center';

                        actRow.innerHTML = `
                        <div>
                            <input type="text" placeholder="Activity Name" value="${act.label}" onchange="updateAct(${lineIndex}, ${actIndex}, 'label', this.value)">
                        </div>
                        <div>
                            <input type="number" placeholder="#" value="${act.amount}" onchange="updateAct(${lineIndex}, ${actIndex}, 'amount', this.value)">
                        </div>
                        <div>
                             <select onchange="updateAct(${lineIndex}, ${actIndex}, 'unit', this.value)" style="font-size:0.7rem;">
                                <option value="Hours" ${act.unit === 'Hours' ? 'selected' : ''}>Hours</option>
                                <option value="Days" ${act.unit === 'Days' ? 'selected' : ''}>Work Days</option>
                                <option value="Weeks" ${act.unit === 'Weeks' ? 'selected' : ''}>Work Weeks</option>
                                <option value="Months" ${act.unit === 'Months' ? 'selected' : ''}>Work Months</option>
                            </select>
                        </div>
                        <div>
                             <select onchange="updateAct(${lineIndex}, ${actIndex}, 'frequency', this.value)" style="font-size:0.7rem;">
                                <option value="Per Day" ${act.frequency === 'Per Day' ? 'selected' : ''}>Per Work Day</option>
                                <option value="Per Week" ${act.frequency === 'Per Week' ? 'selected' : ''}>Per Work Week</option>
                                <option value="Per Month" ${act.frequency === 'Per Month' ? 'selected' : ''}>Per Work Month</option>
                                <option value="Per Year" ${act.frequency === 'Per Year' ? 'selected' : ''}>Per Work Year</option>
                            </select>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--color-text-muted); white-space: nowrap;">
                            ${displayValue}
                        </div>
                        <button onclick="removeActivity(${lineIndex}, ${actIndex})" style="border:none; bg:none; cursor:pointer;">&times;</button>
                    `;
                        actsContainer.appendChild(actRow);
                    });

                    card.appendChild(actsContainer);
                    LineManager.container.appendChild(card);
                });

                if (profile.linesOfWork.length > 0) {
                    const bottomBtn = document.createElement('button');
                    bottomBtn.innerText = "+ New Line";
                    bottomBtn.style.fontSize = "0.8rem";
                    bottomBtn.style.padding = "5px 10px";
                    bottomBtn.style.marginTop = "10px";
                    bottomBtn.style.cursor = "pointer";
                    bottomBtn.style.width = "100%";
                    bottomBtn.style.border = "1px dashed #ccc";
                    bottomBtn.style.background = "#fafafa";
                    bottomBtn.onclick = () => LineManager.addLine();
                    LineManager.container.appendChild(bottomBtn);
                }
            },

            addLine: () => {
                profile.linesOfWork.push({
                    id: crypto.randomUUID(),
                    label: 'New Line of Work',
                    duration: { value: 52, unit: 'Weeks' },
                    activities: [],
                    overheadProjectId: ''
                });
                renderLinesOfWork();
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            },

            removeLine: (index) => {
                if (confirm('Delete this line of work?')) {
                    profile.linesOfWork.splice(index, 1);
                    renderLinesOfWork();
                    calculateAndDisplay();
                    Store.saveIndependentProfile(profile);
                }
            },

            updateLine: (index, field, value) => {
                profile.linesOfWork[index][field] = value;
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            },

            pendingOverride: null,

            updateLineDuration: (index, subField, value) => {
                const newVal = subField === 'value' ? parseFloat(value) : value;
                const currentObj = profile.linesOfWork[index].duration;
                const proposedValue = subField === 'value' ? newVal : currentObj.value;
                const proposedUnit = subField === 'unit' ? newVal : currentObj.unit;
                const globalWeeks = parseFloat(inputs.weeks.value) || 0;
                const proposedWeeks = Normalizer.getLineWeeks(proposedValue, proposedUnit, globalWeeks);

                if (proposedWeeks > globalWeeks) {
                    LineManager.pendingOverride = { index, subField, value: newVal };
                    const msg = `This duration (<strong>${Math.round(proposedWeeks)} weeks</strong>) exceeds your declared Time Reclaimed Schedule (<strong>${globalWeeks} weeks</strong>).<br><br>Do you want to override and keep this duration?`;
                    document.getElementById('modal-override-msg').innerHTML = msg;
                    document.getElementById('modal-override').showModal();
                    return;
                }

                profile.linesOfWork[index].duration[subField] = newVal;
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
                if (subField === 'unit') renderLinesOfWork();
            },

            confirmOverride: () => {
                if (LineManager.pendingOverride) {
                    const { index, subField, value } = LineManager.pendingOverride;
                    profile.linesOfWork[index].duration[subField] = value;
                    calculateAndDisplay();
                    Store.saveIndependentProfile(profile);
                    if (subField === 'unit') renderLinesOfWork();
                    LineManager.pendingOverride = null;
                }
                document.getElementById('modal-override').close();
            },

            cancelOverride: () => {
                LineManager.pendingOverride = null;
                document.getElementById('modal-override').close();
                renderLinesOfWork();
            },

            addActivity: (lineIndex) => {
                profile.linesOfWork[lineIndex].activities.push({
                    label: '',
                    amount: 0,
                    unit: 'Hours',
                    frequency: 'Per Week'
                });
                renderLinesOfWork();
                Store.saveIndependentProfile(profile);
            },

            removeActivity: (lineIndex, actIndex) => {
                profile.linesOfWork[lineIndex].activities.splice(actIndex, 1);
                renderLinesOfWork();
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            },

            updateActivity: (lineIndex, actIndex, field, value) => {
                const val = (field === 'amount') ? parseFloat(value) : value;
                profile.linesOfWork[lineIndex].activities[actIndex][field] = val;
                calculateAndDisplay();
                Store.saveIndependentProfile(profile);
            }
        };

        const renderLinesOfWork = LineManager.render;
        window.updateLine = LineManager.updateLine;
        window.updateLineDuration = LineManager.updateLineDuration;
        window.removeLine = LineManager.removeLine;
        window.addActivity = LineManager.addActivity;
        window.removeActivity = LineManager.removeActivity;
        window.updateAct = LineManager.updateActivity;
        window.confirmOverride = LineManager.confirmOverride;
        window.cancelOverride = LineManager.cancelOverride;
        window.updateExpense = ExpenseManager.updateExpense;
        window.removeExpense = ExpenseManager.removeExpense;
        window.updateIncome = IncomeManager.updateIncome;
        window.removeIncome = IncomeManager.removeIncome;

        document.getElementById('btn-add-line-of-work').onclick = LineManager.addLine;
        document.getElementById('btn-add-expense').onclick = ExpenseManager.addExpense;
        document.getElementById('btn-add-income').onclick = IncomeManager.addIncome;
        document.getElementById('btn-add-overhead-profile').onclick = BusinessProfileManager.create;

        function calculateAndDisplay() {
            const weeks = parseFloat(inputs.weeks.value) || 0;
            const days = parseFloat(inputs.days.value) || 0;
            const hours = parseFloat(inputs.hours.value) || 0;
            const taxRate = parseFloat(inputs.taxRate.value) || 0;

            if (!profile.schedule) profile.schedule = {};
            profile.schedule.weeks = weeks;
            profile.schedule.days = days;
            profile.schedule.hours = hours;
            if (!profile.expenses) profile.expenses = {};
            profile.expenses.taxRate = taxRate;

            const capacity = Utils.calculateBillableCapacity(profile);
            const totalWorkHours = capacity.totalWorkHours;
            const totalNonBillableHours = capacity.totalNonBillableHours;
            const totalBillableHours = capacity.totalBillableHours;

            const nbPercent = totalWorkHours > 0 ? (totalNonBillableHours / totalWorkHours) * 100 : 0;
            const bPercent = totalWorkHours > 0 ? (totalBillableHours / totalWorkHours) * 100 : 0;

            profile.billableRatio = capacity.billableRatio;
            Store.saveIndependentProfile(profile);

            outputs.totalWorkHours.textContent = Math.round(totalWorkHours).toLocaleString();
            outputs.totalNonBillable.innerHTML = `${Math.round(totalNonBillableHours).toLocaleString()} <span style="font-size:0.7em; opacity:0.7;">(${Math.round(nbPercent)}%)</span>`;
            outputs.totalBillable.innerHTML = `${Math.round(totalBillableHours).toLocaleString()} <span style="font-size:0.7em; opacity:0.7;">(${Math.round(bPercent)}%)</span>`;

            let fixedSum = 0;
            let percentSum = 0;

            profile.expenses.items.forEach(item => {
                const amount = parseFloat(item.amount) || 0;
                if (item.type === 'Monthly') {
                    fixedSum += amount * 12;
                } else if (item.type === 'Periodic') {
                    const freq = parseFloat(item.frequency) || 1;
                    fixedSum += amount * freq;
                } else if (item.type === 'Percent') {
                    percentSum += amount;
                }
            });

            overheadProjects.forEach(proj => {
                if (proj.expenses) {
                    proj.expenses.forEach(item => {
                        const amount = parseFloat(item.amount) || 0;
                        if (item.type === 'Annual') {
                            fixedSum += amount;
                        }
                    });
                }
            });

            let unearnedSum = 0;
            profile.unearnedIncome.items.forEach(item => {
                const amount = parseFloat(item.amount) || 0;
                if (item.type === 'Monthly') {
                    unearnedSum += amount * 12;
                } else if (item.type === 'Periodic') {
                    const freq = parseFloat(item.frequency) || 1;
                    unearnedSum += amount * freq;
                } else {
                    unearnedSum += amount;
                }
            });

            const unearnedTotalEl = document.getElementById('out-total-unearned-income');
            if (unearnedTotalEl) {
                unearnedTotalEl.textContent = Utils.formatCurrency(unearnedSum);
            }

            let goalNetTotal = 0;
            if (percentSum < 100) {
                goalNetTotal = fixedSum / (1 - (percentSum / 100));
            } else {
                goalNetTotal = Infinity;
            }

            let goalNetWork = goalNetTotal;
            let goalGross = 0;
            if (goalNetWork !== Infinity) {
                goalGross = goalNetWork * (1 + (taxRate / 100));
            } else {
                goalGross = Infinity;
            }

            const currentNet = profile.currentNetIncome || 0;
            const currentGross = currentNet * (1 + (taxRate / 100));

            outputs.goalNet.textContent = Utils.formatCurrency(goalNetWork);
            outputs.goalGross.textContent = Utils.formatCurrency(goalGross);

            const outCurrentGross = document.getElementById('out-current-gross');
            if (outCurrentGross) {
                outCurrentGross.textContent = Utils.formatCurrency(currentGross);
            }

            profile.goals = {
                net: goalNetWork,
                gross: goalGross,
                current: currentGross
            };
            Store.saveIndependentProfile(profile);

            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = Utils.formatCurrency(val);
            };

            const hasBillableHours = totalBillableHours > 0;
            const pBillable = totalWorkHours > 0 ? (totalBillableHours / totalWorkHours) : 0;
            const weeksPerYear = weeks || 0;
            const calculateFees = (grossAmount, isGoal = false) => {
                if (weeksPerYear <= 0 || pBillable <= 0) {
                    return { hourly: 0, daily: 0, weekly: 0, monthly: 0 };
                }
                const adjustedGross = Math.max(0, grossAmount - unearnedSum);
                const weekly = adjustedGross / weeksPerYear / pBillable;
                const monthly = weekly * weeksPerYear / 12;
                const daily = days > 0 ? (weekly / days) : 0;
                const hourly = hours > 0 ? (daily / hours) : 0;
                return { hourly, daily, weekly, monthly };
            };

            const goalFees = calculateFees(goalGross, true);
            setVal('out-goal-hourly', goalFees.hourly);
            setVal('out-goal-daily', goalFees.daily);
            setVal('out-goal-weekly', goalFees.weekly);
            setVal('out-goal-monthly', goalFees.monthly);

            const nowFees = calculateFees(currentGross, false);
            setVal('out-now-hourly', nowFees.hourly);
            setVal('out-now-daily', nowFees.daily);
            setVal('out-now-weekly', nowFees.weekly);
            setVal('out-now-monthly', nowFees.monthly);
        }

        // 3. Initialization
        async function init() {
            logToScreen("Init() started.");
            try {
                logToScreen("Fetching Profile...");
                try {
                    profile = await Store.getIndependentProfile();
                    logToScreen("Profile loaded: " + (profile ? "Found" : "Null"));
                } catch (e) {
                    logToScreen("Profile Fetch Error: " + e.message);
                }

                try {
                    overheadProjects = await Store.getOverheadProjects();
                    if (!Array.isArray(overheadProjects)) overheadProjects = [];
                } catch (e) {
                    console.error("Overhead Load Error:", e);
                    overheadProjects = [];
                }

                if (!profile) profile = {};
                if (!profile.linesOfWork) profile.linesOfWork = [];
                if (!profile.expenses) profile.expenses = {};

                if (!profile.expenses.items || profile.expenses.items.length === 0) {
                    logToScreen("Expenses empty/missing. Restoring Defaults...");
                    profile.expenses.items = BASE_EXPENSE_CATEGORIES.map(item => ({
                        id: crypto.randomUUID(),
                        ...item,
                        amount: 0
                    }));
                    if (profile.expenses.taxRate === undefined) profile.expenses.taxRate = 30;
                }

                if (!profile.unearnedIncome || !profile.unearnedIncome.items) {
                    profile.unearnedIncome = { items: [] };
                }

                if (profile.schedule) {
                    inputs.weeks.value = profile.schedule.weeks;
                    inputs.days.value = profile.schedule.days;
                    inputs.hours.value = profile.schedule.hours;
                }

                if (profile.expenses.taxRate !== undefined) {
                    inputs.taxRate.value = profile.expenses.taxRate;
                }

                const currentNetInput = document.getElementById('in-current-net-income');
                if (currentNetInput) {
                    currentNetInput.value = profile.currentNetIncome || 0;
                    currentNetInput.addEventListener('input', (e) => {
                        profile.currentNetIncome = parseFloat(e.target.value) || 0;
                        Store.saveIndependentProfile(profile);
                    });
                }

                LineManager.render();
                ExpenseManager.render();
                logToScreen("Expenses Rendered. Count: " + (profile.expenses.items ? profile.expenses.items.length : 0));
                IncomeManager.render();
                BusinessProfileManager.render();
                calculateAndDisplay();
                logToScreen("Init Complete. UI should be ready.");

                ['weeks', 'days', 'hours'].forEach(key => {
                    inputs[key].addEventListener('input', (e) => {
                        profile.schedule[key] = parseFloat(e.target.value);
                        Store.saveIndependentProfile(profile);
                        calculateAndDisplay();
                    });
                });

                inputs.taxRate.addEventListener('input', (e) => {
                    profile.expenses.taxRate = parseFloat(e.target.value);
                    Store.saveIndependentProfile(profile);
                    calculateAndDisplay();
                });
            } catch (e) {
                console.error("Critical Init Error:", e);
                logToScreen("CRITICAL ERROR: " + e.message);
            }
        }

        // Start
        init();
    </script>
    <script>
        // Authentication Check
        (async () => {
            const user = await Store.checkSession();
            if (!user) return;
        })();
    </script>
</body>

</html>
```